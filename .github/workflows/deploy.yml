name: Deploy to Dokku

on:
  push:
    branches:
      - master
      - main

env:
  NODE_VERSION: '22'

jobs:
  detect-changes:
    name: Detect affected apps
    runs-on: ubuntu-latest
    outputs:
      api-affected: ${{ steps.affected.outputs.api }}
      web-affected: ${{ steps.affected.outputs.web }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache NX
        uses: actions/cache@v4
        with:
          path: .nx/cache
          key: nx-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-
            nx-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Detect affected projects
        id: affected
        run: |
          # Get affected projects
          AFFECTED=$(npx nx show projects --affected --base=HEAD~1 --head=HEAD 2>/dev/null || echo "")

          echo "Affected projects: $AFFECTED"

          # Check if specific apps are affected
          if echo "$AFFECTED" | grep -q "@pitanga\/pitanga-api"; then
            echo "api=true" >> $GITHUB_OUTPUT
          else
            echo "api=false" >> $GITHUB_OUTPUT
          fi

          if echo "$AFFECTED" | grep -q "^@pitanga\/pitanga$"; then
            echo "web=true" >> $GITHUB_OUTPUT
          else
            echo "web=false" >> $GITHUB_OUTPUT
          fi

  deploy-api:
    name: Deploy API
    needs: detect-changes
    if: needs.detect-changes.outputs.api-affected == 'true'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.DOKKU_HOST }}" ]; then
            echo "::error::DOKKU_HOST secret is not configured"
            exit 1
          fi
          if [ -z "${{ secrets.DOKKU_SSH_PRIVATE_KEY }}" ]; then
            echo "::error::DOKKU_SSH_PRIVATE_KEY secret is not configured"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DOKKU_SSH_PRIVATE_KEY }}

      - name: Add Dokku host to known_hosts
        env:
          DOKKU_HOST: ${{ secrets.DOKKU_HOST }}
          DOKKU_SSH_PORT: ${{ secrets.DOKKU_SSH_PORT }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Use custom port if specified, otherwise default to 22
          SSH_PORT="${DOKKU_SSH_PORT:-22}"

          echo "Scanning host: $DOKKU_HOST on port $SSH_PORT"
          ssh-keyscan -p "$SSH_PORT" -H "$DOKKU_HOST" >> ~/.ssh/known_hosts || {
            echo "::error::Failed to scan SSH host keys from $DOKKU_HOST:$SSH_PORT"
            echo "Please verify:"
            echo "  1. DOKKU_HOST secret contains only the hostname (not host:port)"
            echo "  2. If using non-standard port, set DOKKU_SSH_PORT secret"
            echo "  3. The host is reachable from GitHub Actions"
            exit 1
          }

      - name: Deploy to Dokku
        env:
          DOKKU_HOST: ${{ secrets.DOKKU_HOST }}
          DOKKU_SSH_PORT: ${{ secrets.DOKKU_SSH_PORT }}
        run: |
          SSH_PORT="${DOKKU_SSH_PORT:-22}"

          # Configure SSH to use custom port if needed
          if [ "$SSH_PORT" != "22" ]; then
            echo "Host $DOKKU_HOST" >> ~/.ssh/config
            echo "  Port $SSH_PORT" >> ~/.ssh/config
          fi

          git remote add dokku "dokku@${DOKKU_HOST}:pitanga-api"
          git push dokku HEAD:refs/heads/main --force

      - name: Deployment summary
        run: echo "✅ API deployed to https://api.pitanga.digital"

  deploy-web:
    name: Deploy Web
    needs: detect-changes
    if: needs.detect-changes.outputs.web-affected == 'true'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.DOKKU_HOST }}" ]; then
            echo "::error::DOKKU_HOST secret is not configured"
            exit 1
          fi
          if [ -z "${{ secrets.DOKKU_SSH_PRIVATE_KEY }}" ]; then
            echo "::error::DOKKU_SSH_PRIVATE_KEY secret is not configured"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DOKKU_SSH_PRIVATE_KEY }}

      - name: Add Dokku host to known_hosts
        env:
          DOKKU_HOST: ${{ secrets.DOKKU_HOST }}
          DOKKU_SSH_PORT: ${{ secrets.DOKKU_SSH_PORT }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Use custom port if specified, otherwise default to 22
          SSH_PORT="${DOKKU_SSH_PORT:-22}"

          echo "Scanning host: $DOKKU_HOST on port $SSH_PORT"
          ssh-keyscan -p "$SSH_PORT" -H "$DOKKU_HOST" >> ~/.ssh/known_hosts || {
            echo "::error::Failed to scan SSH host keys from $DOKKU_HOST:$SSH_PORT"
            echo "Please verify:"
            echo "  1. DOKKU_HOST secret contains only the hostname (not host:port)"
            echo "  2. If using non-standard port, set DOKKU_SSH_PORT secret"
            echo "  3. The host is reachable from GitHub Actions"
            exit 1
          }

      - name: Deploy to Dokku
        env:
          DOKKU_HOST: ${{ secrets.DOKKU_HOST }}
          DOKKU_SSH_PORT: ${{ secrets.DOKKU_SSH_PORT }}
        run: |
          SSH_PORT="${DOKKU_SSH_PORT:-22}"

          # Configure SSH to use custom port if needed
          if [ "$SSH_PORT" != "22" ]; then
            echo "Host $DOKKU_HOST" >> ~/.ssh/config
            echo "  Port $SSH_PORT" >> ~/.ssh/config
          fi

          git remote add dokku "dokku@${DOKKU_HOST}:pitanga-web"
          git push dokku HEAD:refs/heads/main --force

      - name: Deployment summary
        run: echo "✅ Web deployed to https://pitanga.digital"

  summary:
    name: Deployment Summary
    needs: [detect-changes, deploy-api, deploy-web]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-changes.outputs.api-affected }}" == "true" ]; then
            echo "- ✅ **API**: Deployed to https://api.pitanga.digital" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ⏭️ **API**: No changes detected, skipped" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.detect-changes.outputs.web-affected }}" == "true" ]; then
            echo "- ✅ **Web**: Deployed to https://pitanga.digital" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ⏭️ **Web**: No changes detected, skipped" >> $GITHUB_STEP_SUMMARY
          fi
